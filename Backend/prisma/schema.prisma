// This is your Prisma schema file
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-1.0.x", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  // url      = env("DATABASE_URL")
}

// =============================================
// USER & AUTHENTICATION
// =============================================

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String // bcrypt hashed
  firstName String
  lastName  String
  role      UserRole @default(SUPER_ADMIN)
  isActive  Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  MANAGER
  ACCOUNTANT
}

// =============================================
// EMPLOYEE MANAGEMENT
// =============================================

model Employee {
  id           String         @id @default(uuid())
  firstName    String
  lastName     String
  email        String?
  phone        String
  address      String?
  nicNumber    String         @unique
  gender       Gender
  age          Int
  employeeType EmployeeType
  status       EmployeeStatus @default(ACTIVE)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  salaryConfigs  SalaryConfig[]
  submissions    TaskSubmission[]
  completedTasks CompletedTask[]
  payrolls       Payroll[]
  attendance     Attendance[]

  @@map("employees")
}

// ... existing enums ...

// =============================================
// ATTENDANCE MANAGEMENT
// =============================================

model Attendance {
  id          String           @id @default(uuid())
  employeeId  String
  date        DateTime         @db.Date
  arrivalTime String? // HH:mm format
  leftTime    String? // HH:mm format
  otPrice     Decimal?         @default(0) @db.Decimal(10, 2)
  status      AttendanceStatus @default(PRESENT)
  notes       String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@unique([employeeId, date])
  @@index([employeeId])
  @@index([date])
  @@map("attendance")
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  LEAVE
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum EmployeeType {
  PERMANENT
  TEMPORARY
}

enum EmployeeStatus {
  ACTIVE
  INACTIVE
}

// =============================================
// SALARY CONFIGURATION (for Permanent Employees)
// =============================================

model SalaryConfig {
  id            String    @id @default(uuid())
  employeeId    String
  basicSalary   Decimal   @db.Decimal(10, 2)
  allowance     Decimal   @default(0) @db.Decimal(10, 2)
  epfPercentage Decimal   @default(8) @db.Decimal(5, 2) // Employee contribution
  etfPercentage Decimal   @default(3) @db.Decimal(5, 2) // Employer contribution
  effectiveFrom DateTime  @default(now())
  effectiveTo   DateTime?
  isActive      Boolean   @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([employeeId])
  @@map("salary_configs")
}

// =============================================
// TASK TYPES
// =============================================

model TaskType {
  id          String     @id @default(uuid())
  name        String     @unique
  description String?
  price       Decimal    @db.Decimal(10, 2)
  status      TaskStatus @default(ACTIVE)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  priceHistory   TaskPriceHistory[]
  completedTasks CompletedTask[]

  @@map("task_types")
}

enum TaskStatus {
  ACTIVE
  INACTIVE
}

// =============================================
// TASK PRICE HISTORY
// =============================================

model TaskPriceHistory {
  id         String   @id @default(uuid())
  taskTypeId String
  oldPrice   Decimal  @db.Decimal(10, 2)
  newPrice   Decimal  @db.Decimal(10, 2)
  changedBy  String // User ID who changed the price
  reason     String?
  createdAt  DateTime @default(now())

  // Relationships
  taskType TaskType @relation(fields: [taskTypeId], references: [id], onDelete: Cascade)

  @@index([taskTypeId])
  @@map("task_price_history")
}

// =============================================
// COMPLETED TASKS (Daily Task Entries)
// =============================================

model CompletedTask {
  id            String   @id @default(uuid())
  employeeId    String
  submissionId  String
  taskTypeId    String
  quantity      Int
  priceAtTime   Decimal  @db.Decimal(10, 2)
  totalAmount   Decimal  @db.Decimal(10, 2)
  completedDate DateTime @default(now())
  notes         String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  employee   Employee       @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  taskType   TaskType       @relation(fields: [taskTypeId], references: [id])
  submission TaskSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  @@index([employeeId])
  @@index([taskTypeId])
  @@index([submissionId])
  @@index([completedDate])
  @@map("completed_tasks")
}

// =============================================
// TASK SUBMISSIONS (Grouped Task Entries)
// =============================================

model TaskSubmission {
  id             String   @id @default(uuid())
  employeeId     String
  totalAmount    Decimal  @db.Decimal(10, 2)
  submissionDate DateTime @default(now())
  notes          String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  employee Employee        @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  tasks    CompletedTask[]

  @@index([employeeId])
  @@index([submissionDate])
  @@map("task_submissions")
}

// =============================================
// PAYROLL
// =============================================

model Payroll {
  id           String       @id @default(uuid())
  employeeId   String
  month        Int // 1-12
  year         Int
  employeeType EmployeeType

  // For Permanent Employees
  basicSalary     Decimal? @db.Decimal(10, 2)
  allowance       Decimal? @db.Decimal(10, 2)
  epfDeduction    Decimal? @db.Decimal(10, 2)
  etfContribution Decimal? @db.Decimal(10, 2)

  // For Temporary Employees (sum of completed tasks)
  totalTaskAmount Decimal? @db.Decimal(10, 2)

  // Final Amounts
  netSalary Decimal @db.Decimal(10, 2)

  status      PayrollStatus @default(PENDING)
  generatedBy String // User ID
  generatedAt DateTime      @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  employee Employee @relation(fields: [employeeId], references: [id])

  @@unique([employeeId, month, year])
  @@index([employeeId])
  @@index([month, year])
  @@map("payrolls")
}

enum PayrollStatus {
  PENDING
  APPROVED
  PAID
}

// =============================================
// AUDIT LOGS
// =============================================

model AuditLog {
  id         String   @id @default(uuid())
  userId     String
  action     String // e.g., "TASK_PRICE_UPDATE", "EMPLOYEE_CREATED"
  entityType String // e.g., "TaskType", "Employee"
  entityId   String
  oldValue   String? // JSON string
  newValue   String? // JSON string
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}
